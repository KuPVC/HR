[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Leave Application",
  "enabled": 1,
  "modified": "2024-09-25 16:02:55.609131",
  "module": "Craft HR",
  "name": "Leave",
  "script": "frappe.ui.form.on('Leave Application', {\r\n    from_date: function (frm) {\r\n        update_leave_entitlement(frm);\r\n    },\r\n    employee: function (frm) {\r\n        frm.trigger('from_date'); // Trigger from_date update when employee is changed\r\n    }\r\n});\r\n\r\nfunction update_leave_entitlement(frm) {\r\n    // Get the employee's date of joining and used leaves\r\n    if (frm.doc.employee) {\r\n        frappe.call({\r\n            method: 'frappe.client.get_value',\r\n            args: {\r\n                doctype: 'Employee',\r\n                filters: { name: frm.doc.employee },\r\n                fieldname: ['date_of_joining']\r\n            },\r\n            callback: function (r) {\r\n                if (r.message) {\r\n                    var date_of_joining = r.message.date_of_joining;\r\n                    var from_date = frm.doc.from_date;\r\n\r\n                    if (date_of_joining && from_date) {\r\n                        // Calculate the number of months\r\n                        var months = calculate_months(date_of_joining, from_date);\r\n                        var total_entitlement = (months < 12) ? months * 2 : months * 2.5;\r\n\r\n                        // Get used leave balance\r\n                        frappe.call({\r\n                            method: \"hrms.hr.doctype.leave_application.leave_application.get_leave_balance_on\",\r\n                            args: {\r\n                                employee: frm.doc.employee,\r\n                                date: frm.doc.from_date,\r\n                                to_date: frm.doc.to_date,\r\n                                leave_type: frm.doc.leave_type,\r\n                                consider_all_leaves_in_the_allocation_period: 1\r\n                            },\r\n                            callback: function (r) {\r\n                                if (!r.exc && r.message) {\r\n                                    var used_leaves = r.message;\r\n                                    var final_value = total_entitlement - used_leaves;\r\n\r\n                                    // Set the value in the custom field\r\n                                    frm.set_value('custom_leave_entitlement_as_of_leave_start_date', final_value);\r\n                                } else {\r\n                                    frm.set_value('custom_leave_entitlement_as_of_leave_start_date', total_entitlement);\r\n                                }\r\n                            }\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nfunction calculate_months(date_of_joining, from_date) {\r\n    // Convert dates to moment.js objects\r\n    var start = moment(date_of_joining);\r\n    var end = moment(from_date);\r\n\r\n    // Calculate the number of months and round down\r\n    var months = Math.floor(end.diff(start, 'months', true));\r\n\r\n    return months;\r\n}\r\n",
  "view": "Form"
 }
]